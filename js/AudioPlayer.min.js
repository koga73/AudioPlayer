/*
* AudioPlayer v1.0.0 Copyright (c) 2016 AJ Savino
* https://github.com/koga73/AudioPlayer
* MIT LICENSE
*/
if(!OOP){var OOP=function(){var e={namespace:function(e,n){for(var t=e.split("."),r=t.length,a=window,v=0;r>v;v++){var i=t[v];a[i]=v==r-1?n:a[i]||{},a[i]._type=t.slice(0,v+1).join("."),a=a[i]}return n},extend:function(n,t){if("undefined"==typeof n)throw"Error base object is undefined";if(!e._isFunction(n))throw"Error base object must be a function";var r=new n;for(var a in r)"undefined"==typeof t[a]&&(t[a]=r[a]);var v=r;do v._interface=t,v=v._super;while("undefined"!=typeof v);return t._super=r,t},construct:function(n,t,r){var a=null;arguments&&arguments.callee&&arguments.callee.caller&&(a=arguments.callee.caller._type,n._type=a),n._isType=function(t){return e.isType(n,t)},n._interface=n;for(var v in t)e._isFunction(n[v])?n[v](t[v]):n[v]=t[v];return 1==r&&(n._eventHandlers||(n._eventHandlers={}),n.addEventListener||(n.addEventListener=e._addEventListener),n.removeEventListener||(n.removeEventListener=e._removeEventListener),n.dispatchEvent||(n.dispatchEvent=e._dispatchEvent)),n},event:function(e,n){var t=null;try{t=new CustomEvent(e)}catch(r){document.createEventObject?(t=document.createEventObject("Event"),t.initCustomEvent&&t.initCustomEvent(e,!0,!0)):t={}}return t._type=e,t._data=n,t},addEventListener:function(n,t,r){n._eventHandlers||(n._eventHandlers={}),t=t.split(",");for(var a=t.length,v=0;a>v;v++){var i=t[v];if(n.addEventListener)r=e._addEventHandler(n,i,r),n.addEventListener(i,r);else if(n.attachEvent){var d=function(){r(window.event)};d.handler=r,d=e._addEventHandler(n,i,d),n.attachEvent("on"+i,d)}else"undefined"!=typeof jQuery?(r=e._addEventHandler(n,i,r),jQuery.on(i,r)):(n.addEventListener=e._addEventListener,n.addEventListener(i,r))}},_addEventListener:function(n,t){t._isCustom=!0,e._addEventHandler(this,n,t)},_addEventHandler:function(e,n,t){e._eventHandlers[n]||(e._eventHandlers[n]=[]);for(var r=e._eventHandlers[n],a=r.length,v=0;a>v;v++){if(r[v]===t)return t;if(r[v].handler&&r[v].handler===t)return r[v]}return r.push(t),t},removeEventListener:function(n,t,r){n._eventHandlers||(n._eventHandlers={}),t=t.split(",");for(var a=t.length,v=0;a>v;v++){var i,d=t[v];i="undefined"==typeof r?n._eventHandlers[d]||[]:[r];for(var s=i.length,o=0;s>o;o++){var r=i[o];n.removeEventListener?(r=e._removeEventHandler(n,d,r),n.removeEventListener(d,r)):n.detachEvent?(r=e._removeEventHandler(n,d,r),n.detachEvent("on"+d,r)):"undefined"!=typeof jQuery?(r=e._removeEventHandler(n,d,r),jQuery.off(d,r)):(n.removeEventListener=e._removeEventListener,n.removeEventListener(d,r))}}},_removeEventListener:function(n,t){n=n.split(",");for(var r=n.length,a=0;r>a;a++){var v,i=n[a];v="undefined"==typeof t?this._eventHandlers[i]||[]:[t];for(var d=v.length,s=0;d>s;s++){var t=v[s];t._isCustom=!1,e._removeEventHandler(this,i,t)}}},_removeEventHandler:function(e,n,t){e._eventHandlers[n]||(e._eventHandlers[n]=[]);for(var r=e._eventHandlers[n],a=r.length,v=0;a>v;v++){if(r[v]===t)return r.splice(v,1)[0];if(r[v].handler&&r[v].handler===t)return r.splice(v,1)[0]}},dispatchEvent:function(n,t){n._eventHandlers||(n._eventHandlers={}),n.dispatchEvent?n.dispatchEvent(t):n.fireEvent?n.fireEvent("on"+type,t):"undefined"!=typeof jQuery?jQuery(n).trigger(jQuery.Event(t._type,{_type:t._type,_data:t._data})):(n.dispatchEvent=e._dispatchEvent,n.dispatchEvent(t))},_dispatchEvent:function(n){e._dispatchEventHandlers(this,n)},_dispatchEventHandlers:function(e,n){var t=e._eventHandlers[n._type];if(t)for(var r=t.length,a=0;r>a;a++)t[a](n)},isType:function(e,n){var t=e;do{if(t._type==n||t._type==n._type)return!0;t=t._super}while("undefined"!=typeof t);return!1},_isFunction:function(e){return e&&"[object Function]"==Object.prototype.toString.call(e)}};return{Namespace:e.namespace,Extend:e.extend,Construct:e.construct,Event:e.event,addEventListener:e.addEventListener,removeEventListener:e.removeEventListener,dispatchEvent:e.dispatchEvent,isType:e.isType}}();}
OOP.Namespace("AudioPlayer",function(e){var t=null,n={context:null,analyzer:null,gain:null,bufferSource:null,buffer:null,debug:!1,autoPlay:!1,autoLoop:!1,_src:null,_fileName:null,_volume:1,_isReady:!1,_isPlaying:!1,_isPaused:!1,_isMuted:!1,_lastVolume:-1,_lastTime:-1,_state:null},a={init:function(){if(!("AudioContext"in window))throw new Error("Your browser does not support AudioContext");var e=new AudioContext,u=e.createAnalyser();u.connect(e.destination),t.analyzer=u;var o=e.createGain();o.connect(u),t.gain=o,t.context=e,a._stateChange(AudioPlayer.STATES.IDLE),n._src&&a._load(n._src)},destroy:function(){t.buffer=null,t.stop(),t.gain=null,t.analyzer=null,t.context&&(t.context.close(),t.context=null),a._stateChange(null)},src:function(e){return"undefined"!=typeof e&&(n._src=e,n._state&&a._load(n._src)),n._src},volume:function(e){return"undefined"!=typeof e&&(n._volume=e,t.gain.gain.value=n._volume),n._volume},fileName:function(){return n._fileName},currentTime:function(){return t.context.currentTime},duration:function(){return t.buffer.duration},isPlaying:function(){return n._isPlaying},isPaused:function(){return n._isPaused},isMuted:function(){return n._isMuted},state:function(){return n._state},play:function(e,u){if("undefined"==typeof e&&(e=n._isPaused?n._lastTime:0),u=u===!0,!n._isPlaying){n._isPaused&&(n._isPaused=!1,t.stop()),n._isPlaying=!0;var o=t.context,r=o.createBufferSource();r.connect(t.gain),r.start||(r.start=r.noteOn,r.stop=r.noteOff),r.onended=function(e){n._isPlaying&&(n._isPlaying=!1,a._stateChange(AudioPlayer.STATES.COMPLETE))},t.bufferSource=r,a._log("PLAY: "+n._fileName+" | startTime:"+e+" | loop:"+u,"#0080FF"),a._stateChange(AudioPlayer.STATES.PLAYING),r.buffer=t.buffer,r.loop=u,r.start(0,e)}},pause:function(){n._isPlaying&&(n._isPaused||(a._stateChange(AudioPlayer.STATES.PAUSED),n._lastTime=t.currentTime(),t.stop(),n._isPaused=!0))},stop:function(){if(n._isPlaying){a._stateChange(AudioPlayer.STATES.STOPPED),n._isPlaying=!1,n._isPaused=!1;var e=t.bufferSource;e.stop(),e.onended=null,e=null}},seek:function(e){a._log("SEEK: "+e,"#0080FF"),t.stop(),n._isPaused?n._lastTime=e:t.play(e)},analyze:function(){var e=t.analyzer,n=new Uint8Array(e.frequencyBinCount);return e.getByteFrequencyData(n),n},mute:function(){n._isMuted||(a._log("MUTE","#0080FF"),n._isMuted=!0,n._lastVolume=t.volume(),t.volume(0))},unmute:function(){n._isMuted&&(a._log("UNMUTE","#0080FF"),n._isMuted=!1,t.volume(n._lastVolume))},_stateChange:function(e){a._log("EVENT_STATE_CHANGE: "+e,"#FF8000"),n._state=e,t.dispatchEvent(new OOP.Event(AudioPlayer.EVENT_STATE_CHANGE,n._state))},_log:function(e,n){t.debug&&console.log("%c"+e,"color:"+n+";")},_load:function(e){n._isReady=!1,a._stateChange(AudioPlayer.STATES.LOADING),a._isObject(e)?(n._fileName=e.name,a._handler_loaded(e)):(n._fileName=e,a._ajax({url:e,responseType:"blob",onSuccess:a._handler_loaded}))},_handler_loaded:function(e){var u=n._fileName;a._log("FILE LOADED: "+u,"#0080FF"),a._stateChange(AudioPlayer.STATES.PROCESSING);var o=new FileReader;o.onload=function(e){a._log("DECODING AUDIO: "+u,"#0080FF");var o=e.target.result;t.context.decodeAudioData(o,function(e){t.buffer=e,n._isReady=!0,a._log("AUDIO PROCESSED: "+u,"#0080FF"),a._stateChange(AudioPlayer.STATES.READY),t.autoPlay&&t.play(0,t.autoLoop)})},o.readAsArrayBuffer(e)},_ajax:function(e){var t={url:null,onSuccess:null,onError:null,verb:"GET",data:null,contentType:null,responseType:null};for(var n in e)t[n]=e[n];var a;try{a=new XMLHttpRequest}catch(u){a=new ActiveXObject("Microsoft.XMLHTTP")}var o=function(){if(!t.onError)throw new Error("Request for '"+t.url+"' returned a "+a.status);t.onError({params:t,status:a.status})};a.onload=function(){a.status>=200&&a.status<400?t.onSuccess(a.response):o()},a.onerror=o,a.open(t.verb,t.url,!0),t.contentType&&(a.setRequestHeader("Content-type",t.contentType),a.setRequestHeader("Accept",t.contentType)),t.responseType&&(a.responseType=t.responseType),t.data?a.send(data):a.send()},_isObject:function(e){return null!=e&&"object"==typeof e}};return t=OOP.Construct({context:n.context,buffer:n.buffer,bufferSource:n.bufferSource,analyzer:n.analyzer,gain:n.gain,debug:n.debug,autoPlay:n.autoPlay,autoLoop:n.autoLoop,src:a.src,autoPlay:a.autoPlay,volume:a.volume,fileName:a.fileName,currentTime:a.currentTime,duration:a.duration,isPlaying:a.isPlaying,isPaused:a.isPaused,isMuted:a.isMuted,state:a.state,init:a.init,destroy:a.destroy,play:a.play,pause:a.pause,stop:a.stop,seek:a.seek,analyze:a.analyze,mute:a.mute,unmute:a.unmute},e,!0),t.init(),t}),OOP.Namespace("AudioPlayer.EVENT_STATE_CHANGE","change"),OOP.Namespace("AudioPlayer.STATES",{IDLE:"idle",LOADING:"loading",PROCESSING:"processing",READY:"ready",PLAYING:"playing",PAUSED:"paused",STOPPED:"stopped",COMPLETE:"complete"});